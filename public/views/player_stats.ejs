<!DOCTYPE html>

<html>
    <head>
        <title><%= generalInfo.athlete.displayName %> Stats</title>
        <link rel="stylesheet" href="/styles/player_stats.css">
    </head>

    <body>

        <%- include ('menu_header') %>

        <div id="playerInfoDiv">
            <img id="headshot" src="<%= generalInfo.athlete.headshot.href %>"> <!--player pic-->
            <h1><%= generalInfo.athlete.displayName %></h1> <!--player name-->
            <div id="extraPlayerInfo">
                <img id="teamLogo" src="<%= generalInfo.athlete.team.logos[0].href %>">
                <h2><%= generalInfo.athlete.team.displayName + " " + generalInfo.athlete.position.displayName %></h2>
                <h3>No. <%= generalInfo.athlete.jersey %></h3>
            </div>
         
        </div>

        <h2>Player Stats for <%= playerOverview.statistics.displayName.split(' ')[0] %> Season</h2>

        <div id="mainStats">

            <table>
                <!--get col names and descriptions-->
                <tr>
                    <th>Category</th>
                    <% for (let i = 0; i < playerOverview.statistics.labels.length; i++){ %>
                        <th>
                            <div class="tooltip"><%= playerOverview.statistics.labels[i] %>
                                <span class="tooltip-text">
                                    <%= playerOverview.statistics.displayNames[i] %>
                                </span>
                            </div>
                        </th>
                    <% } %>
                </tr>

                <!--Now do rows for reg season, postseason, and career-->
                <% playerOverview.statistics.splits.forEach(split => { %>
                    <tr>
                        <th><%= split.displayName %></th>
                        <% split.stats.forEach(stat => { %>
                            <td><%= stat %></td>
                        <% }) %>
                    </tr>
                <% }) %>
            </table>
        </div>

       <div id="advancedStatsSection">
            <div id="advancedStatsFilter">
                <label for="catSelect">Select a Category</label>
                <select id="catSelect" name="catSelect">
                    <% let index = 0;
                    playerSplits.splitCategories.forEach(category => { %>

                        <option value="<%= index %>"><%= category.displayName %></option>

                    <% index++;
                    }) %>
                </select>

                <label for="splitSelect">Select a Stat:</label>
                <% playerSplits.splitCategories.forEach(category => { 
                    index = 0; %>

                    <select name="splitSelect" class="splitSelect">
                        <option value="-1">--</option>
                        <% category.splits.forEach(split => { %>
                            <option value="<%= index %>"><%= split.displayName %></option>
                        <% index++; }) %>
                    </select>
                <% }) %>
            </div>

            <div id="advancedStatsTables">

                <h3>Showing Stats for <%= playerSplits.splitCategories[0].splits[0].displayName %></h3>

                <table id="advancedSplitsTable">
                    <tr>
                        <% for (let i = 0; i < playerSplits.labels.length; i++) { %>
                            <th>
                                <div class="tooltip"><%= playerSplits.labels[i] %>
                                    <span class="tooltip-text">
                                        <%= playerSplits.displayNames[i] %>
                                    </span>
                                </div>
                            </th>
                        <% } %>
                    </tr>
                    <tr>
                        <% playerSplits.splitCategories[0].splits[0].stats.forEach(stat => { %>
                            <td><%= stat %></td> 
                        <% }) %>
                    </tr>
                </table>
            </div>
        </div>

        <%- include ('footer') %>

        <script>

            const categorySelector = document.getElementById('catSelect');
            const statSelectors = document.querySelectorAll('.splitSelect');
            const advancedSplitsTable = document.getElementById('advancedSplitsTable');

            statSelectors.forEach(selector => selector.style.display = 'none');
            statSelectors[0].style.display = 'inline';

            //make stat selects and tables appear
            function toggleStatSelect(){
                const index = categorySelector.value;
                statSelectors.forEach(select => select.style.display = 'none');
                statSelectors[index].style.display = 'inline';
            }

            function clearTable(){
                const index = categorySelector.value;
                advancedSplitsTable.replaceChildren(advancedSplitsTable.rows[0]);
                //make stat selector default option
                statSelectors[index].value = -1;
            }

            function getSplits(){
                const catIndex = categorySelector.value;
                const splitIndex = statSelectors[catIndex].value;
                advancedSplitsTable.replaceChildren(advancedSplitsTable.rows[0]);
                if (splitIndex != -1){
                    const row = document.createElement('tr');
                    const playerSplits = <%- JSON.stringify(playerSplits) %>;
                    playerSplits.splitCategories[catIndex].splits[splitIndex].stats.forEach(stat => {
                        const cell = document.createElement('td');
                        cell.textContent = stat;
                        row.append(cell);
                    });
                    advancedSplitsTable.append(row);
                }
            }

            toggleStatSelect;

            categorySelector.addEventListener('change', toggleStatSelect);
            categorySelector.addEventListener('change', clearTable);
            statSelectors.forEach(selector => {
                selector.addEventListener('change', getSplits);
            });

        </script>
    </body>
</html>