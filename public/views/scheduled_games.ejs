<%
    //filter the games depending on if finished, active or upcoming to divide them into sections on page
    const upcomingGames = data.events.filter(game => game.status.type.state == "pre");
    const activeGames = data.events.filter(game => game.status.type.state == "in");
    const completedGames = data.events.filter(game => game.status.type.state == "post");

    const today = new Date();
    const month = (today.getMonth() + 1 < 10) ? "0" + (today.getMonth() + 1).toString() : 
        (today.getMonth() + 1).toString();
    const day = today.getDate().toString();
    const year = today.getFullYear().toString();
    const fullDate = year + "-" + month + "-" + day;

    const localDate = new Date(data.leagues[0].season.endDate);
    const year2 = localDate.getFullYear();
    const month2 = String(localDate.getMonth() + 1).padStart(2, '0');
    const day2 = String(localDate.getDate()).padStart(2, '0');
    const endDate = `${year2}-${month2}-${day2}`;


    const seasonTypeGames = (data.events.length != 0) ? data.events[0].season.slug.charAt(0).toUpperCase()
        + data.events[0].season.slug.slice(1) : "";

    const postseasonGames = [{key: 1, value: "Wild Card"}, {key: 2, value: "Divisional"},
        {key: 3, value: "Conference"}, {key: 5, value: "Super Bowl"}];
%> 

<!DOCTYPE html>
<html>

<head>
    <title><%= league.toUpperCase() %> Games</title>
    <link rel="stylesheet" href="/styles/league_schedule.css">
</head>

<body>

    <%- include ('menu_header') %>

    <div class="topSection">
        
        <div class="titleSection">
            <% if (league.toUpperCase() == "MLB"){ %>
                <img src = '/images/mlb_logo.png' class='mainLogo' alt = 'MLB Logo'>
            <% } else if (league.toUpperCase() == "NBA"){ %>
                <img src = '/images/nba_logo.png' class='mainLogo' alt = 'NBA Logo'>
            <% } else if (league.toUpperCase() == "NFL"){ %>
                <img src = '/images/nfl_logo.png' class='mainLogo' alt = 'NFL Logo'>
            <% } else { %>
                <img src = '/images/nhl_logo.png' class='mainLogo' alt = 'NHL Logo'>
            <% } %>
            <h1><%= league.toUpperCase() %> Scheduled Games</h1>
        </div>

        <% if (league.toUpperCase() == "NFL"){ %>

            <!--This will be what we select for the week, will show all games for the week-->
            <div class="form-container">
                <form method="GET">

                    <div class="form-group">
                        <label for="season">Select Season:</label>
                        <select name="season">
                            <% for (let i = year; i >= 2000; i--){ %>
                                <option value="<%= i %>"><%= i %></option>
                            <% } %>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="seasonType">Select Season Type:</label>
                        <select id="typeSelector" name="seasonType">
                            <option value="2">Regular Season</option>
                            <option value="3">Postseason</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="week">Select Week:</label>
                        <select id="weekSelector" name="week"></select>
                    </div>

                    <button>Submit</button>
                </form>
            </div>

        <% } else { %>

            <div class="date-wrapper">
                <form id="dateSelection" method="GET">
                    <input id="date" name="date" type="date" max="<%= endDate %>">
                    <button type="submit">Submit</button>
                </form>
            </div>
        <% } %>
    </div>


    <% if (data.events.length == 0){ %>
        
        <h1 id="noGamesWarning">No Games Scheduled</h1>

    <% } else if (league.toUpperCase() == "NFL") { %> 
        <h2 id="dateHeader">
            <% if (data.season.type == 3){ %>
                <%= postseasonGames.find(round => round.key == data.week.number).value %>
            <% } else { %>
                <%= "Week " + data.week.number %>
            <% } %>
        </h2> 
    <% } %>

    <h3 class="sectionHeadline">Active <%= seasonTypeGames %> Games</h3>
    <div id="activeGames" class="gamesLayout">

        <% activeGames.forEach(game => { %>

            <div id="<%= game.id %>" class="gameContainer">
                <div class="awayTeamDiv">
                    <img class="teamLogo" src="<%= game.competitions[0].competitors[1].team.logo %>">
                    <p><%= game.competitions[0].competitors[1].team.abbreviation %></p>
                </div>

                <div class="gameTimeDiv">
                    <p class="status"><%= game.competitions[0].status.type.shortDetail %></p>
                    <p class="mlbCount">
                        <% if (league.toUpperCase() == "MLB"){ %>
                            <%= game.competitions[0].situation.balls + "-" + game.competitions[0].situation.strikes
                                +  " " + game.competitions[0].situation.outs + " outs" %>
                        <% } %>
                    </p>
                    <img class="arrow_img" src="/images/left_arrow.png">
                    <p class="yardMarker">
                        <% if (league.toUpperCase() == "NFL" && game.competitions[0].situation !== undefined){ %>
                            <%= game.competitions[0].situation.downDistanceText %>
                        <% } %>
                    </p>
                    <p class="score"><%= game.competitions[0].competitors[1].score %> - 
                        <%= game.competitions[0].competitors[0].score %></p>
                    <p class="seriesRecord" style="display:none"></p>
                    <a href="http://localhost:<%= port %>/<%= sport %>/<%= league %>/games/<%= game.id %>">
                        Game Stats
                    </a>
                </div>

                <div class="homeTeamDiv">
                    <img class="teamLogo" src="<%= game.competitions[0].competitors[0].team.logo %>">
                    <p><%= game.competitions[0].competitors[0].team.abbreviation %></p>
                </div>
            </div>
        <% }) %>
    </div>
        
    <h3 class="sectionHeadline">Upcoming <%= seasonTypeGames %> Games</h3>
    <div id="upcomingGames" class="gamesLayout">

        <% upcomingGames.forEach(game => { %>

            <div id="<%= game.id %>" class="gameContainer">
                <div class="awayTeamDiv">
                    <img class="teamLogo" src="<%= game.competitions[0].competitors[1].team.logo %>">
                    <p><%= game.competitions[0].competitors[1].team.abbreviation %></p>
                </div>

                <div class="gameTimeDiv">
                    <p class="status">
                        <% if (data.day !== undefined && fullDate != data.day.date){ %>
                            <%= game.competitions[0].status.type.shortDetail %>
                        <% } else { %>
                            <%= game.competitions[0].status.type.shortDetail.substring(
                                game.competitions[0].status.type.shortDetail.indexOf("-") + 2); %>
                        <% } %>
                    </p>
                    <p class="mlbCount" style="display:none"></p>
                    <img class="arrow_img" src="/images/left_arrow.png">
                    <p class="yardMarker"></p>
                    <p class="score"></p>
                    <p class="seriesRecord">
                        <% if (data.leagues[0].season.type.type == 3){ %>
                            <%= game.competitions[0].series.summary %>
                        <% } %>
                    </p>
                    <% if (game.competitions[0].status.type.shortDetail != "TBD"){ %>
                        <a href="http://localhost:<%= port %>/<%= sport %>/<%= league %>/games/<%= game.id %>">
                            Game Stats
                        </a>
                    <% } %>
                </div>

                <div class="homeTeamDiv">
                    <img class="teamLogo" src="<%= game.competitions[0].competitors[0].team.logo %>">
                    <p><%= game.competitions[0].competitors[0].team.abbreviation %></p>
                </div>
            </div>

        <% }) %>
    </div>
        
    <h3 class="sectionHeadline">Completed <%= seasonTypeGames %> Games</h3>
    <div id="completedGames" class="gamesLayout">
        
        <% completedGames.forEach(game => { %>

            <div id="<%= game.id %>" class="gameContainer">
                <div class="awayTeamDiv">
                    <img class="teamLogo" src="<%= game.competitions[0].competitors[1].team.logo %>">
                    <p><%= game.competitions[0].competitors[1].team.abbreviation %></p>
                </div>

                <div class="gameTimeDiv">
                    <p class="status"><%= game.competitions[0].status.type.detail %></p>
                    <p class="mlbCount"></p>
                    <img class="arrow_img" src="/images/left_arrow.png">
                    <p class="yardMarker"></p>
                    <p class="score">
                        <%= game.competitions[0].competitors[1].score %> - 
                        <%= game.competitions[0].competitors[0].score %>
                    </p>
                    <p class="seriesRecord">
                        <% if (game.competitions[0].series !== undefined){ %>
                            <%= game.competitions[0].series.summary %>
                        <% } %>
                    </p>
                    <a href="http://localhost:<%= port %>/<%= sport %>/<%= league %>/games/<%= game.id %>">
                        Game Stats
                    </a>
                </div>

                <div class="homeTeamDiv">
                    <img class="teamLogo" src="<%= game.competitions[0].competitors[0].team.logo %>">
                    <p><%= game.competitions[0].competitors[0].team.abbreviation %></p>
                </div>
            </div>

        <% }) %>
    </div>

    <% if (league.toUpperCase() == "NFL" && data.week.teamsOnBye !== undefined){ %>
        <h3 id="byeWeekHeadline" class="importantHeadline">Teams on Bye Week</h3>
        <div id="byeWeekSection">
            <% data.week.teamsOnBye.forEach(team => { %>
                <div class="byeTeamsDiv">
                    <img class="teamLogo" src="<%= team.logo %>">
                    <p><%= team.abbreviation %></p>
                </div>
            <% }) %>
        </div>
    <% } %>

    <script>

        const form = document.getElementById("dateSelection");
        const dateInput = document.getElementById('date');

        //selectors
        const typeSelector = document.getElementById('typeSelector');
        const weekSelector = document.getElementById('weekSelector');

        //divs
        const upcomingGames = document.getElementById('upcomingGames');
        const activeGames = document.getElementById('activeGames');
        const completedGames = document.getElementById('completedGames');
        const headlines = document.querySelectorAll('.sectionHeadline');
        const upcoming = document.getElementById('upcomingHeadline');

        //endpoint to send requests to
        const endpoint = <%- JSON.stringify(endpoint) %>;
        const league = <%- JSON.stringify(league) %>;

        //hide game active sections within the games yet to start
        upcomingGames.querySelectorAll('.gameContainer').forEach(game => {
            game.querySelector('.score').style.display = 'none';
            game.querySelector('.mlbCount').style.display = 'none';
            game.querySelector('.yardMarker').style.display = 'none';
            game.querySelector('.arrow_img').style.display = 'none';
        });

        //hide mlb count and football marker in the finished games
        completedGames.querySelectorAll('.gameContainer').forEach(game => {
            game.querySelector('.mlbCount').style.display = 'none';
            game.querySelector('.yardMarker').style.display = 'none';
            game.querySelector('.arrow_img').style.display = 'none';
        });

        activeGames.querySelectorAll('.gameContainer').forEach(game => {
            if (league.toUpperCase() != "MLB"){
                game.querySelector('.mlbCount').style.display = 'none';
            }
            if (league.toUpperCase() != "NFL"){
                game.querySelector('.arrow_img').style.display = 'none';
                game.querySelector('.yardMarker').style.display = 'none';
            }
        });


        if (activeGames.children.length == 0){
            headlines[0].style.display = 'none';
        }
        if (upcomingGames.children.length == 0){ 
            headlines[1].style.display = 'none';
        }
        if (completedGames.children.length == 0){ 
            headlines[2].style.display = 'none';
        }

        //this is the function to get the week options for football games
        function getOptions(){

            const type = typeSelector.value;
            weekSelector.innerHTML = '';

            if (type == "2"){
                
                for (let i = 1; i < 19; i++){
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = "Week " + i.toString();
                    weekSelector.appendChild(option);
                }

            } else {

                const postseasonGames = [{key: 1, value: "Wild Card"}, {key: 2, value: "Divisional"},
                    {key: 3, value: "Conference"}, {key: 5, value: "Super Bowl"}];
                
                postseasonGames.forEach(round => {
                    const option = document.createElement('option');
                    option.value = round.key;
                    option.textContent = round.value;
                    weekSelector.appendChild(option);
                });
            }
        }

        if (typeSelector){ //if its for football games, add listener for week selection

            typeSelector.addEventListener('change', getOptions);
            getOptions();

        } else { //otherwise, add listener for date selection

            form.addEventListener("submit", function() {
                const dateValue = date.value;

                if (!dateValue) {
                    event.preventDefault();
                    alert('Please select a date.');
                    return;
                }
            });
        }

        async function updateGames(){

            console.log("hello");

            //get the data from the response
            const update = await (await fetch(endpoint)).json();

            //first go through upcoming games to see if any have started
            upcomingGames.querySelectorAll('.gameContainer').forEach(gameDiv => {
                const gameID = gameDiv.id;
                const gameData = update.events.find(event => event.id == gameID);

                const status = gameDiv.querySelector('.status');
                const score = gameDiv.querySelector('.score');
                const mlbCount = gameDiv.querySelector('.mlbCount');
                const yardMarker = gameDiv.querySelector('.yardMarker');
                const arrowImage = gameDiv.querySelector('.arrow_img');
                const seriesRecord = gameDiv.querySelector('.seriesRecord');

                //if the game has started, move it to active games
                if (gameData.status.type.state != "pre"){

                    seriesRecord.style.display = "none";

                    //update the status of the game
                    status.textContent = gameData.status.type.shortDetail;

                    //update baseball count if in MLB game
                    mlbCount.style.display = (league.toUpperCase() == "MLB" && gameData.competitions[0].situation !== undefined) ? "flex" : "none";
                    mlbCount.textContent = (league.toUpperCase() == "MLB" && gameData.competitions[0].situation !== undefined) ? 
                        gameData.competitions[0].situation.balls + "-" + gameData.competitions[0].situation.strikes +  " " + 
                            gameData.competitions[0].situation.outs + " outs" : "";

                    //update football marker if in NFL game
                    arrowImage.style.display = (league.toUpperCase() == "NFL" && gameData.competitions[0].situation !== undefined) ? "flex" : "none";
                    if (league.toUpperCase() == "NFL" && gameData.competitions[0].situation !== undefined){
                        if (gameData.competitions[0].situation.possession == 
                            gameData.competitions[0].competitors[1].id){
                            arrowImage.src = "/images/left_arrow.png";
                        } else {
                            arrowImage.src = "/images/right_arrow.png";
                        }
                    }

                    //get score of game
                    score.style.display = "flex";
                    score.textContent = gameData.competitions[0].competitors[1].score + " - "
                        + gameData.competitions[0].competitors[0].score;

                    gameDiv.parentNode.removeChild(gameDiv); //remove from upcoming

                    //add to active games
                    if (activeGames.children.length == 0){
                        headlines[0].style.display = 'flex';
                    }
                    if (upcomingGames.children.length == 0){
                        headlines[1].style.display = 'none';
                    }
                    activeGames.appendChild(gameDiv);
                }
            });

            activeGames.querySelectorAll('.gameContainer').forEach(gameDiv => {
                const gameID = gameDiv.id;
                const gameData = update.events.find(event => event.id == gameID);

                const status = gameDiv.querySelector('.status');
                const score = gameDiv.querySelector('.score');
                const mlbCount = gameDiv.querySelector('.mlbCount');
                const yardMarker = gameDiv.querySelector('.yardMarker');
                const arrowImage = gameDiv.querySelector('.arrow_img');
                const seriesRecord = gameDiv.querySelector('.seriesRecord');

                //update the status of the game
                status.textContent = gameData.status.type.shortDetail;

                //get score of game
                score.textContent = gameData.competitions[0].competitors[1].score + " - "
                    + gameData.competitions[0].competitors[0].score;

                //if the game is now finished, move it to completed games
                if (gameData.status.type.state == "post"){

                    //hide any baseball and football in game details
                    mlbCount.style.display = "none";
                    yardMarker.style.display = "none";
                    arrowImage.style.display = "none";

                    //for series score updates on final games
                    if (gameData.competitions[0].series !== undefined){
                        seriesRecord.style.display = "flex";
                        seriesRecord.textContent = gameData.competitions[0].series.summary;
                    } else {
                        seriesRecord.style.display = "none";
                    }

                    gameDiv.parentNode.removeChild(gameDiv); //remove from active

                    //add to completed games
                    if (completedGames.children.length == 0){
                        headlines[2].style.display = 'flex';
                    }
                    //hide activeGames headline if no more active games
                    if (activeGames.children.length == 0){
                        headlines[0].style.display = 'none';
                    }
                    completedGames.appendChild(gameDiv);
                }
            });

            if (activeGames.children.length == 0 && upcomingGames.children.length == 0){
                clearInterval(requests);
            }
        }
        
        let requests = setInterval(updateGames, 10000); //update games every 20 seconds
        //immediately clear it if all games are already final upon initial page load or user refresh
        if (activeGames.children.length == 0 && upcomingGames.children.length == 0){
            clearInterval(requests);
        }
  </script>
</body>
</html>